<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EventBusComponent Demo - Harmony Design System</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
    }

    .demo-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .demo-section h2 {
      margin-top: 0;
      color: #555;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      background: #4ec9b0;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    button:hover {
      background: #3da890;
    }

    button.secondary {
      background: #569cd6;
    }

    button.secondary:hover {
      background: #4080b0;
    }

    button.error {
      background: #f48771;
    }

    button.error:hover {
      background: #d06751;
    }

    .info-box {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 12px;
      margin: 16px 0;
      border-radius: 4px;
    }

    .info-box code {
      background: #c8e6c9;
      padding: 2px 6px;
      border-radius: 2px;
      font-family: 'Consolas', 'Monaco', monospace;
    }

    .event-log {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
    }

    .event-log div {
      margin: 4px 0;
      padding: 4px;
      border-left: 2px solid #ccc;
      padding-left: 8px;
    }
  </style>
</head>
<body>
  <h1>EventBusComponent Demo</h1>

  <div class="info-box">
    Press <code>Ctrl+Shift+E</code> to toggle the EventBus Monitor.
    The monitor will appear in the bottom-right corner showing all event activity.
  </div>

  <div class="demo-section">
    <h2>Test Event Generation</h2>
    <p>Click these buttons to generate test events that will appear in the EventBus Monitor:</p>
    
    <div class="button-group">
      <button id="btn-play">Play Command</button>
      <button id="btn-pause">Pause Command</button>
      <button id="btn-stop">Stop Command</button>
      <button class="secondary" id="btn-load">Load Audio</button>
      <button class="secondary" id="btn-seek">Seek Position</button>
      <button class="error" id="btn-error">Trigger Error</button>
    </div>
  </div>

  <div class="demo-section">
    <h2>Simulated EventBus Activity</h2>
    <p>This demo simulates EventBus activity. In a real application, these would be actual events from components and bounded contexts.</p>
    
    <div class="button-group">
      <button id="btn-batch">Generate Batch Events</button>
      <button id="btn-auto">Auto-generate Events</button>
      <button id="btn-stop-auto">Stop Auto-generate</button>
    </div>

    <h3>Local Event Log</h3>
    <div class="event-log" id="local-log">
      No events generated yet.
    </div>
  </div>

  <!-- Include the EventBusComponent -->
  <event-bus-component></event-bus-component>

  <script type="module">
    import '../../../src/components/debug/event-bus-component.js';

    // Mock EventBus for demo purposes
    window.EventBus = {
      subscribers: {},
      
      subscribe(eventType, callback) {
        if (!this.subscribers[eventType]) {
          this.subscribers[eventType] = [];
        }
        this.subscribers[eventType].push(callback);
        
        return () => {
          this.subscribers[eventType] = this.subscribers[eventType].filter(cb => cb !== callback);
        };
      },
      
      publish(eventType, payload) {
        const event = {
          type: 'command',
          eventType: eventType,
          timestamp: Date.now(),
          source: 'demo-page',
          payload: payload
        };
        
        console.log(`EventBus: ${eventType}`, payload);
        
        // Notify all subscribers
        const wildcardSubs = this.subscribers['*'] || [];
        const specificSubs = this.subscribers[eventType] || [];
        
        [...wildcardSubs, ...specificSubs].forEach(callback => {
          try {
            callback(event);
          } catch (error) {
            console.error('EventBus subscriber error:', error);
          }
        });

        // Log to local display
        this.logToLocal(eventType, payload);
      },

      logToLocal(eventType, payload) {
        const localLog = document.getElementById('local-log');
        const time = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.textContent = `[${time}] ${eventType}: ${JSON.stringify(payload)}`;
        localLog.insertBefore(entry, localLog.firstChild);
        
        // Keep only last 10 entries
        while (localLog.children.length > 10) {
          localLog.removeChild(localLog.lastChild);
        }
      }
    };

    // Button event handlers
    document.getElementById('btn-play').addEventListener('click', () => {
      EventBus.publish('PlayCommand', { trackId: 'track-001' });
    });

    document.getElementById('btn-pause').addEventListener('click', () => {
      EventBus.publish('PauseCommand', {});
    });

    document.getElementById('btn-stop').addEventListener('click', () => {
      EventBus.publish('StopCommand', {});
    });

    document.getElementById('btn-load').addEventListener('click', () => {
      EventBus.publish('LoadAudioCommand', { 
        url: 'https://example.com/audio.mp3',
        format: 'mp3'
      });
    });

    document.getElementById('btn-seek').addEventListener('click', () => {
      EventBus.publish('SeekCommand', { 
        position: Math.random() * 180 
      });
    });

    document.getElementById('btn-error').addEventListener('click', () => {
      const errorEvent = {
        type: 'error',
        eventType: 'ValidationError',
        timestamp: Date.now(),
        source: 'demo-page',
        payload: { field: 'trackId', reason: 'Invalid format' },
        error: 'Track ID must be in format: track-XXX'
      };
      
      console.error('EventBus Error:', errorEvent.error);
      
      // Trigger error in EventBus subscribers
      const subs = EventBus.subscribers['*'] || [];
      subs.forEach(callback => callback(errorEvent));
    });

    let batchInterval = null;

    document.getElementById('btn-batch').addEventListener('click', () => {
      const commands = [
        { type: 'LoadAudioCommand', payload: { url: 'track1.mp3' } },
        { type: 'PlayCommand', payload: { trackId: 'track-001' } },
        { type: 'VolumeChangeCommand', payload: { volume: 0.75 } },
        { type: 'SeekCommand', payload: { position: 30 } },
        { type: 'PlaybackStartedResult', payload: { trackId: 'track-001', duration: 180 } }
      ];

      commands.forEach((cmd, index) => {
        setTimeout(() => {
          EventBus.publish(cmd.type, cmd.payload);
        }, index * 100);
      });
    });

    document.getElementById('btn-auto').addEventListener('click', () => {
      if (batchInterval) return;

      const commands = [
        'PlayCommand',
        'PauseCommand',
        'SeekCommand',
        'VolumeChangeCommand',
        'PlaybackProgressResult'
      ];

      batchInterval = setInterval(() => {
        const randomCmd = commands[Math.floor(Math.random() * commands.length)];
        const randomPayload = {
          value: Math.random(),
          timestamp: Date.now()
        };
        EventBus.publish(randomCmd, randomPayload);
      }, 1000);
    });

    document.getElementById('btn-stop-auto').addEventListener('click', () => {
      if (batchInterval) {
        clearInterval(batchInterval);
        batchInterval = null;
      }
    });

    // Auto-show the EventBus component on load for demo purposes
    setTimeout(() => {
      const eventBusComponent = document.querySelector('event-bus-component');
      if (eventBusComponent) {
        eventBusComponent.isVisible = true;
        eventBusComponent.applyVisibility();
      }
    }, 500);
  </script>
</body>
</html>