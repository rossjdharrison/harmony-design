<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Error Handler Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: #ffffff;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #2a2a2a;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #2563eb;
    }
    .stats {
      margin-top: 20px;
      padding: 15px;
      background: #1a1a1a;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>Global Error Handler Test</h1>

  <div class="test-section">
    <h2>Error Simulation</h2>
    <button onclick="testUnhandledError()">Trigger Unhandled Error</button>
    <button onclick="testPromiseRejection()">Trigger Promise Rejection</button>
    <button onclick="testCustomError()">Trigger Custom Error</button>
    <button onclick="testAudioError()">Trigger Audio Error</button>
    <button onclick="testRepeatedError()">Trigger Repeated Error (5x)</button>
  </div>

  <div class="test-section">
    <h2>Toast Variations</h2>
    <button onclick="testWarningToast()">Show Warning Toast</button>
    <button onclick="testSuccessToast()">Show Success Toast</button>
    <button onclick="testInfoToast()">Show Info Toast</button>
    <button onclick="testPersistentToast()">Show Persistent Toast</button>
    <button onclick="testActionToast()">Show Toast with Action</button>
  </div>

  <div class="test-section">
    <h2>Controls</h2>
    <button onclick="showStats()">Show Statistics</button>
    <button onclick="clearHistory()">Clear History</button>
    <button onclick="clearToasts()">Clear All Toasts</button>
  </div>

  <div class="stats" id="stats"></div>

  <!-- Toast container -->
  <harmony-toast-container></harmony-toast-container>

  <script type="module">
    import { EventBus } from './event-bus.js';
    import { globalErrorHandler } from './global-error-handler.js';
    import { HarmonyToastContainer } from '../components/toast/harmony-toast-container.js';

    // Initialize
    const eventBus = new EventBus();
    globalErrorHandler.initialize(eventBus);

    console.log('Global Error Handler Test initialized');

    // Test functions
    window.testUnhandledError = () => {
      throw new Error('Test unhandled error');
    };

    window.testPromiseRejection = () => {
      Promise.reject(new Error('Test promise rejection'));
    };

    window.testCustomError = () => {
      globalErrorHandler.reportError(
        new Error('Custom error message'),
        {
          source: 'test-component',
          operation: 'user-action',
          metadata: { userId: 123 },
          timestamp: Date.now()
        }
      );
    };

    window.testAudioError = () => {
      class AudioError extends Error {
        constructor(message) {
          super(message);
          this.name = 'AudioError';
        }
      }

      globalErrorHandler.reportError(
        new AudioError('Failed to initialize audio context'),
        {
          source: 'audio-engine',
          operation: 'initialization',
          timestamp: Date.now()
        }
      );
    };

    window.testRepeatedError = () => {
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          globalErrorHandler.reportError(
            new Error('Repeated error'),
            {
              source: 'test',
              operation: 'repeat-test',
              timestamp: Date.now()
            }
          );
        }, i * 100);
      }
    };

    window.testWarningToast = () => {
      const toast = document.querySelector('harmony-toast-container');
      toast.showToast({
        message: 'This is a warning message',
        severity: 'warning',
        duration: 5000
      });
    };

    window.testSuccessToast = () => {
      const toast = document.querySelector('harmony-toast-container');
      toast.showToast({
        message: 'Operation completed successfully!',
        severity: 'success',
        duration: 3000
      });
    };

    window.testInfoToast = () => {
      const toast = document.querySelector('harmony-toast-container');
      toast.showToast({
        message: 'This is an informational message',
        severity: 'info',
        duration: 4000
      });
    };

    window.testPersistentToast = () => {
      const toast = document.querySelector('harmony-toast-container');
      toast.showToast({
        message: 'This toast will not auto-dismiss',
        severity: 'info',
        duration: 0
      });
    };

    window.testActionToast = () => {
      const toast = document.querySelector('harmony-toast-container');
      toast.showToast({
        message: 'Would you like to retry?',
        severity: 'error',
        duration: 0,
        actionLabel: 'Retry',
        onAction: () => {
          console.log('Retry clicked');
          alert('Retry action triggered!');
        }
      });
    };

    window.showStats = () => {
      const stats = globalErrorHandler.getStatistics();
      const history = globalErrorHandler.getErrorHistory();
      
      document.getElementById('stats').innerHTML = `
        <strong>Error Statistics:</strong><br>
        Total Errors: ${stats.totalErrors}<br>
        Error Counts: ${JSON.stringify(stats.errorCounts, null, 2)}<br>
        Suppressed Errors: ${stats.suppressedErrors.length}<br>
        <br>
        <strong>Recent Errors:</strong><br>
        ${history.slice(-5).map(h => 
          `${h.error.name}: ${h.error.message} (${h.context.source})`
        ).join('<br>')}
      `;
    };

    window.clearHistory = () => {
      globalErrorHandler.clearErrorHistory();
      console.log('Error history cleared');
      window.showStats();
    };

    window.clearToasts = () => {
      const toast = document.querySelector('harmony-toast-container');
      toast.clearAll();
    };
  </script>
</body>
</html>