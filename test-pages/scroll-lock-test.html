<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scroll Lock Test - Harmony Design System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 300vh; /* Make page scrollable */
      padding: 2rem;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    h1 {
      color: #667eea;
      margin-bottom: 1rem;
    }

    h2 {
      color: #764ba2;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .status {
      padding: 1rem;
      background: #f0f0f0;
      border-radius: 4px;
      margin: 1rem 0;
      font-family: 'Courier New', monospace;
    }

    .status.locked {
      background: #ffe0e0;
      border-left: 4px solid #ff4444;
    }

    .status.unlocked {
      background: #e0ffe0;
      border-left: 4px solid #44ff44;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.5rem 0.5rem 0.5rem 0;
      transition: background 0.2s;
    }

    button:hover {
      background: #5568d3;
    }

    button:active {
      background: #4557bb;
    }

    button.secondary {
      background: #764ba2;
    }

    button.secondary:hover {
      background: #653a8a;
    }

    button.danger {
      background: #ff4444;
    }

    button.danger:hover {
      background: #dd3333;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .modal h3 {
      margin-top: 0;
      color: #667eea;
    }

    .modal-content {
      margin: 1rem 0;
    }

    .modal-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .scroll-indicator {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: white;
      padding: 1rem;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      z-index: 2000;
    }

    .content-block {
      background: #f9f9f9;
      padding: 1rem;
      margin: 1rem 0;
      border-left: 4px solid #667eea;
    }

    code {
      background: #f0f0f0;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="scroll-indicator">
    <div>Scroll Y: <span id="scrollY">0</span>px</div>
    <div>Lock Count: <span id="lockCount">0</span></div>
    <div>Status: <span id="lockStatus">Unlocked</span></div>
  </div>

  <div class="container">
    <h1>ðŸ”’ Scroll Lock Test</h1>
    <p>Test body scroll prevention when modals are open.</p>

    <div id="statusDisplay" class="status unlocked">
      Status: <strong>Unlocked</strong> | Locks: <strong>0</strong>
    </div>

    <h2>Basic Tests</h2>
    <div class="content-block">
      <p>Test basic lock/unlock functionality:</p>
      <button id="btnLock">Lock Scroll</button>
      <button id="btnUnlock">Unlock Scroll</button>
      <button id="btnForceUnlock" class="danger">Force Unlock All</button>
    </div>

    <h2>Modal Tests</h2>
    <div class="content-block">
      <p>Test scroll lock with modal dialogs:</p>
      <button id="btnModal1">Open Modal 1</button>
      <button id="btnModal2">Open Modal 2 (Nested)</button>
      <button id="btnModal3">Open Modal 3 (Triple Nested)</button>
    </div>

    <h2>Nested Lock Tests</h2>
    <div class="content-block">
      <p>Test reference counting with multiple locks:</p>
      <button id="btnMultiLock">Lock 3 Times</button>
      <button id="btnMultiUnlock">Unlock 3 Times</button>
      <p><small>Should require 3 unlocks to restore scrolling</small></p>
    </div>

    <h2>Scoped Lock Test</h2>
    <div class="content-block">
      <p>Test automatic cleanup with scoped locks:</p>
      <button id="btnScopedLock">Create Scoped Lock (5s)</button>
      <p><small>Automatically unlocks after 5 seconds</small></p>
    </div>

    <h2>Performance Test</h2>
    <div class="content-block">
      <p>Test rapid lock/unlock operations:</p>
      <button id="btnPerfTest">Run Performance Test</button>
      <div id="perfResults"></div>
    </div>

    <h2>Scroll Content</h2>
    <div class="content-block">
      <p>Scroll down to test scroll position preservation...</p>
    </div>
  </div>

  <!-- Add more content to make page scrollable -->
  <div class="container">
    <h2>More Content (Section 2)</h2>
    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
    <div class="content-block">
      <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
    </div>
  </div>

  <div class="container">
    <h2>More Content (Section 3)</h2>
    <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.</p>
    <div class="content-block">
      <p>Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </div>
  </div>

  <div class="container">
    <h2>End of Page</h2>
    <p>Scroll back up to test the scroll lock functionality.</p>
  </div>

  <!-- Modal 1 -->
  <div id="modal1" class="modal-backdrop">
    <div class="modal">
      <h3>Modal 1</h3>
      <div class="modal-content">
        <p>This is the first modal. Background scrolling should be prevented.</p>
        <p>Try scrolling with your mouse wheel or trackpad - the page behind should not move.</p>
        <div class="content-block">
          <p><strong>Test:</strong> Click outside this modal or press the close button.</p>
        </div>
      </div>
      <div class="modal-actions">
        <button id="btnOpenModal2">Open Modal 2 (Nested)</button>
        <button class="secondary" data-close="modal1">Close</button>
      </div>
    </div>
  </div>

  <!-- Modal 2 -->
  <div id="modal2" class="modal-backdrop">
    <div class="modal">
      <h3>Modal 2 (Nested)</h3>
      <div class="modal-content">
        <p>This is a nested modal. Lock count should be 2.</p>
        <p>Closing this modal should NOT restore scrolling - Modal 1 is still open.</p>
        <div class="content-block">
          <p><strong>Current lock count:</strong> <span class="lock-count-display">-</span></p>
        </div>
      </div>
      <div class="modal-actions">
        <button id="btnOpenModal3">Open Modal 3</button>
        <button class="secondary" data-close="modal2">Close</button>
      </div>
    </div>
  </div>

  <!-- Modal 3 -->
  <div id="modal3" class="modal-backdrop">
    <div class="modal">
      <h3>Modal 3 (Triple Nested)</h3>
      <div class="modal-content">
        <p>This is a triple-nested modal. Lock count should be 3.</p>
        <p>This tests the reference counting system for multiple overlapping locks.</p>
        <div class="content-block">
          <p><strong>Current lock count:</strong> <span class="lock-count-display">-</span></p>
        </div>
      </div>
      <div class="modal-actions">
        <button class="secondary" data-close="modal3">Close</button>
        <button class="danger" id="btnCloseAll">Close All Modals</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { 
      lockScroll, 
      unlockScroll, 
      isScrollLocked, 
      getLockCount,
      forceUnlock,
      createScrollLock
    } from '../utils/scroll-lock.js';

    // Update scroll indicator
    function updateIndicator() {
      document.getElementById('scrollY').textContent = window.scrollY;
      document.getElementById('lockCount').textContent = getLockCount();
      document.getElementById('lockStatus').textContent = isScrollLocked() ? 'Locked' : 'Unlocked';
      
      const statusDisplay = document.getElementById('statusDisplay');
      statusDisplay.className = isScrollLocked() ? 'status locked' : 'status unlocked';
      statusDisplay.innerHTML = `Status: <strong>${isScrollLocked() ? 'Locked' : 'Unlocked'}</strong> | Locks: <strong>${getLockCount()}</strong>`;
      
      // Update modal lock count displays
      document.querySelectorAll('.lock-count-display').forEach(el => {
        el.textContent = getLockCount();
      });
    }

    window.addEventListener('scroll', updateIndicator);
    setInterval(updateIndicator, 100);

    // Basic lock/unlock buttons
    document.getElementById('btnLock').addEventListener('click', () => {
      lockScroll();
      updateIndicator();
      console.log('Scroll locked');
    });

    document.getElementById('btnUnlock').addEventListener('click', () => {
      unlockScroll();
      updateIndicator();
      console.log('Scroll unlocked');
    });

    document.getElementById('btnForceUnlock').addEventListener('click', () => {
      forceUnlock();
      updateIndicator();
      console.log('Force unlocked all');
    });

    // Modal helpers
    function openModal(modalId) {
      lockScroll();
      document.getElementById(modalId).classList.add('active');
      updateIndicator();
      console.log(`Modal ${modalId} opened, lock count: ${getLockCount()}`);
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      unlockScroll();
      updateIndicator();
      console.log(`Modal ${modalId} closed, lock count: ${getLockCount()}`);
    }

    // Modal buttons
    document.getElementById('btnModal1').addEventListener('click', () => openModal('modal1'));
    document.getElementById('btnModal2').addEventListener('click', () => openModal('modal2'));
    document.getElementById('btnModal3').addEventListener('click', () => openModal('modal3'));
    
    document.getElementById('btnOpenModal2').addEventListener('click', () => openModal('modal2'));
    document.getElementById('btnOpenModal3').addEventListener('click', () => openModal('modal3'));

    // Close buttons
    document.querySelectorAll('[data-close]').forEach(btn => {
      btn.addEventListener('click', () => {
        closeModal(btn.dataset.close);
      });
    });

    // Close all modals
    document.getElementById('btnCloseAll').addEventListener('click', () => {
      closeModal('modal3');
      closeModal('modal2');
      closeModal('modal1');
    });

    // Click outside to close
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
          closeModal(backdrop.id);
        }
      });
    });

    // Multiple locks test
    document.getElementById('btnMultiLock').addEventListener('click', () => {
      lockScroll();
      lockScroll();
      lockScroll();
      updateIndicator();
      console.log('Locked 3 times, count:', getLockCount());
    });

    document.getElementById('btnMultiUnlock').addEventListener('click', () => {
      unlockScroll();
      unlockScroll();
      unlockScroll();
      updateIndicator();
      console.log('Unlocked 3 times, count:', getLockCount());
    });

    // Scoped lock test
    document.getElementById('btnScopedLock').addEventListener('click', () => {
      const unlock = createScrollLock();
      updateIndicator();
      console.log('Scoped lock created, will auto-unlock in 5s');
      
      setTimeout(() => {
        unlock();
        updateIndicator();
        console.log('Scoped lock auto-unlocked');
      }, 5000);
    });

    // Performance test
    document.getElementById('btnPerfTest').addEventListener('click', () => {
      const iterations = 10000;
      const resultsDiv = document.getElementById('perfResults');
      resultsDiv.innerHTML = '<p>Running performance test...</p>';
      
      setTimeout(() => {
        const start = performance.now();
        
        for (let i = 0; i < iterations; i++) {
          lockScroll();
          unlockScroll();
        }
        
        const end = performance.now();
        const duration = end - start;
        const opsPerSec = (iterations * 2 / duration * 1000).toFixed(0);
        
        resultsDiv.innerHTML = `
          <p><strong>Results:</strong></p>
          <p>Iterations: ${iterations.toLocaleString()}</p>
          <p>Duration: ${duration.toFixed(2)}ms</p>
          <p>Operations/sec: ${parseInt(opsPerSec).toLocaleString()}</p>
          <p>Avg per operation: ${(duration / iterations / 2).toFixed(4)}ms</p>
        `;
        
        console.log(`Performance test: ${opsPerSec} ops/sec`);
      }, 100);
    });

    // Initial update
    updateIndicator();
    
    console.log('Scroll lock test page loaded');
    console.log('Available functions:', { lockScroll, unlockScroll, isScrollLocked, getLockCount, forceUnlock, createScrollLock });
  </script>
</body>
</html>