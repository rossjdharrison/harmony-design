<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Environment Tokens Test - Harmony Design System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 24px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      margin-bottom: 24px;
      color: #333;
    }

    .test-section {
      background: white;
      padding: 24px;
      margin-bottom: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .test-section h2 {
      margin-bottom: 16px;
      color: #555;
      font-size: 18px;
    }

    .test-result {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    .test-result.pass {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .test-result.fail {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .token-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .token-card {
      padding: 16px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .token-card h3 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #666;
    }

    .token-value {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #333;
      word-break: break-all;
    }

    .color-swatch {
      width: 100%;
      height: 40px;
      border-radius: 4px;
      margin-top: 8px;
      border: 1px solid #ddd;
    }

    .environment-selector {
      margin-bottom: 24px;
      padding: 16px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .environment-selector label {
      margin-right: 16px;
      font-weight: 500;
    }

    .environment-selector select {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    .css-vars-test {
      padding: 16px;
      margin-top: 16px;
      border-radius: 4px;
      background: var(--token-colors-surface, #f8f9fa);
      color: var(--token-colors-text, #212529);
      border: 1px solid var(--token-colors-border, #dee2e6);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ¨ Environment Tokens Test Suite</h1>

    <div class="environment-selector">
      <label for="env-select">Test Environment:</label>
      <select id="env-select">
        <option value="development">Development</option>
        <option value="staging">Staging</option>
        <option value="production">Production</option>
      </select>
    </div>

    <div class="test-section">
      <h2>Unit Tests</h2>
      <div id="unit-tests"></div>
    </div>

    <div class="test-section">
      <h2>Current Environment Tokens</h2>
      <div id="current-env"></div>
      <div id="token-display" class="token-grid"></div>
    </div>

    <div class="test-section">
      <h2>CSS Custom Properties Test</h2>
      <div class="css-vars-test">
        This box uses CSS custom properties from tokens.
        Background: var(--token-colors-surface)
        Text: var(--token-colors-text)
        Border: var(--token-colors-border)
      </div>
    </div>

    <div class="test-section">
      <h2>Environment Comparison</h2>
      <div id="env-comparison"></div>
    </div>
  </div>

  <script type="module">
    import {
      loadEnvironmentTokens,
      getToken,
      setTokenCSSProperties,
      observeEnvironmentTokens,
      __testing__
    } from './environment-tokens.js';

    const { BASE_TOKENS, DEVELOPMENT_TOKENS, STAGING_TOKENS, PRODUCTION_TOKENS, deepMerge } = __testing__;

    // Test results container
    const unitTestsEl = document.getElementById('unit-tests');
    const currentEnvEl = document.getElementById('current-env');
    const tokenDisplayEl = document.getElementById('token-display');
    const envComparisonEl = document.getElementById('env-comparison');
    const envSelect = document.getElementById('env-select');

    function addTestResult(message, passed) {
      const div = document.createElement('div');
      div.className = `test-result ${passed ? 'pass' : 'fail'}`;
      div.textContent = `${passed ? 'âœ“' : 'âœ—'} ${message}`;
      unitTestsEl.appendChild(div);
    }

    // Run unit tests
    function runTests() {
      unitTestsEl.innerHTML = '';

      // Test 1: Base tokens exist
      addTestResult('Base tokens object exists', !!BASE_TOKENS);

      // Test 2: Environment overrides exist
      addTestResult('Development overrides exist', !!DEVELOPMENT_TOKENS);
      addTestResult('Staging overrides exist', !!STAGING_TOKENS);
      addTestResult('Production overrides exist', !!PRODUCTION_TOKENS);

      // Test 3: Load tokens for each environment
      const devTokens = loadEnvironmentTokens('development');
      const stagingTokens = loadEnvironmentTokens('staging');
      const prodTokens = loadEnvironmentTokens('production');

      addTestResult('Development tokens loaded', !!devTokens);
      addTestResult('Staging tokens loaded', !!stagingTokens);
      addTestResult('Production tokens loaded', !!prodTokens);

      // Test 4: Metadata included
      addTestResult('Tokens include metadata', !!devTokens._meta);
      addTestResult('Metadata has environment', devTokens._meta.environment === 'development');

      // Test 5: Deep merge works
      const merged = deepMerge({ a: { b: 1 } }, { a: { c: 2 } });
      addTestResult('Deep merge preserves original keys', merged.a.b === 1);
      addTestResult('Deep merge adds new keys', merged.a.c === 2);

      // Test 6: Get token by path
      const primaryColor = getToken('colors.primary', devTokens);
      addTestResult('Get token by path works', !!primaryColor);

      // Test 7: Environment-specific overrides applied
      const devPrimary = getToken('colors.primary', devTokens);
      const basePrimary = BASE_TOKENS.colors.primary;
      addTestResult('Development overrides applied', devPrimary !== basePrimary);

      // Test 8: Base tokens preserved when no override
      const spacing = getToken('spacing.md', devTokens);
      addTestResult('Base tokens preserved', spacing === BASE_TOKENS.spacing.md);

      // Test 9: Invalid path returns undefined
      const invalid = getToken('invalid.path.here', devTokens);
      addTestResult('Invalid path returns undefined', invalid === undefined);

      // Test 10: CSS properties can be set
      try {
        setTokenCSSProperties(devTokens);
        const cssVar = getComputedStyle(document.documentElement).getPropertyValue('--token-colors-primary');
        addTestResult('CSS custom properties set', !!cssVar);
      } catch (e) {
        addTestResult('CSS custom properties set', false);
      }
    }

    // Display tokens for selected environment
    function displayTokens(environment) {
      const tokens = loadEnvironmentTokens(environment);
      
      currentEnvEl.innerHTML = `
        <strong>Environment:</strong> ${tokens._meta.environment}<br>
        <strong>Loaded:</strong> ${tokens._meta.loadedAt}<br>
        <strong>Base Tokens:</strong> ${tokens._meta.baseTokens}<br>
        <strong>Overrides:</strong> ${tokens._meta.overrides}
      `;

      tokenDisplayEl.innerHTML = '';

      // Display color tokens
      if (tokens.colors) {
        Object.entries(tokens.colors).forEach(([key, value]) => {
          const card = document.createElement('div');
          card.className = 'token-card';
          card.innerHTML = `
            <h3>colors.${key}</h3>
            <div class="token-value">${value}</div>
            <div class="color-swatch" style="background-color: ${value}"></div>
          `;
          tokenDisplayEl.appendChild(card);
        });
      }

      // Update CSS properties
      setTokenCSSProperties(tokens);
    }

    // Compare tokens across environments
    function compareEnvironments() {
      const envs = ['development', 'staging', 'production'];
      const comparison = {};

      envs.forEach(env => {
        comparison[env] = loadEnvironmentTokens(env);
      });

      envComparisonEl.innerHTML = '<h3>Primary Color Comparison:</h3>';
      
      envs.forEach(env => {
        const color = comparison[env].colors.primary;
        const div = document.createElement('div');
        div.style.cssText = `
          padding: 12px;
          margin: 8px 0;
          background: ${color};
          color: white;
          border-radius: 4px;
          font-weight: 500;
        `;
        div.textContent = `${env}: ${color}`;
        envComparisonEl.appendChild(div);
      });
    }

    // Event listeners
    envSelect.addEventListener('change', (e) => {
      displayTokens(e.target.value);
    });

    // Initialize
    runTests();
    displayTokens('development');
    compareEnvironments();

    // Test observer
    const cleanup = observeEnvironmentTokens((tokens) => {
      console.log('Environment tokens updated:', tokens._meta.environment);
    });

    // Cleanup on page unload
    window.addEventListener('unload', cleanup);
  </script>
</body>
</html>