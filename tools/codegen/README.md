# Rust Struct Generator

Automated code generation tool that creates Rust struct definitions from JSON Schema files.

## Purpose

Part of the schema-driven development workflow for the Harmony Design System. Ensures Rust types stay synchronized with JSON schema definitions, supporting the WASM-based bounded context architecture.

## Files

- `rust-struct-generator.py` - Core generator implementation
- `test_rust_struct_generator.py` - Test suite (run with pytest)
- `generate-all-structs.py` - Batch processor for all schemas

## Usage

### Generate from Single Schema

```bash
python tools/codegen/rust-struct-generator.py schemas/domain.schema.json
```

Output to specific file:

```bash
python tools/codegen/rust-struct-generator.py \
  schemas/domain.schema.json \
  harmony-graph/src/generated/domain_generated.rs
```

### Generate from All Schemas

```bash
python tools/codegen/generate-all-structs.py
```

This scans `schemas/*.schema.json` and generates corresponding Rust files in `harmony-graph/src/generated/`.

## Features

### Type Mapping

| JSON Schema Type | Rust Type |
|-----------------|-----------|
| `string` | `String` |
| `integer` | `i64` |
| `number` | `f64` |
| `boolean` | `bool` |
| `array` | `Vec<T>` |
| `object` | `serde_json::Value` |

### Field Handling

- **Required fields**: Direct type (e.g., `String`)
- **Optional fields**: Wrapped in `Option<T>` with `#[serde(skip_serializing_if = "Option::is_none")]`
- **camelCase properties**: Converted to `snake_case` with `#[serde(rename = "...")]`

### References

- `$ref` to `#/definitions/TypeName` generates separate struct
- Referenced types use generated struct name

### Documentation

- Schema `description` becomes `///` doc comment
- Property descriptions become field doc comments

## Example

**Input** (`schemas/domain.schema.json`):

```json
{
  "title": "Domain",
  "description": "Represents a domain in the graph",
  "type": "object",
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique domain identifier"
    },
    "displayName": {
      "type": "string",
      "description": "Human-readable name"
    },
    "nodeCount": {
      "type": "integer",
      "description": "Number of nodes"
    }
  },
  "required": ["id", "displayName"]
}
```

**Output** (`harmony-graph/src/generated/domain_generated.rs`):

```rust
// Generated by rust-struct-generator.py
// DO NOT EDIT MANUALLY - regenerate from schema

use serde::{Deserialize, Serialize};

/// Represents a domain in the graph
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct Domain {
    /// Unique domain identifier
    pub id: String,

    /// Human-readable name
    #[serde(rename = "displayName")]
    pub display_name: String,

    /// Number of nodes
    #[serde(skip_serializing_if = "Option::is_none")]
    #[serde(rename = "nodeCount")]
    pub node_count: Option<i64>,

}
```

## Integration with CI

The codegen pipeline should run as part of CI to ensure generated code stays synchronized with schemas:

1. Schema changes committed
2. CI runs `generate-all-structs.py`
3. CI verifies generated code compiles
4. CI fails if generated code differs from committed version

See policy #6 in DESIGN_SYSTEM.md.

## Testing

Run the test suite:

```bash
cd tools/codegen
pytest test_rust_struct_generator.py -v
```

Tests cover:
- Simple struct generation
- camelCase â†’ snake_case conversion
- Array/Vec types
- Nested references ($ref)
- Optional fields
- Numeric types
- Documentation generation
- Enum handling
- oneOf/anyOf handling

## Limitations

- **Enums**: Currently mapped to `String` with runtime validation. Future: generate proper Rust enums.
- **oneOf/anyOf**: Uses `serde_json::Value`. Future: generate Rust enums with tagged variants.
- **Complex validation**: JSON Schema validation rules (min/max, pattern) not enforced in generated types.

## Related Documentation

- [DESIGN_SYSTEM.md](../../DESIGN_SYSTEM.md) - Schema-driven architecture
- [schemas/README.md](../../schemas/README.md) - Schema conventions
- Policy #5, #6, #24 - Schema change workflow